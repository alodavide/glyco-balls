<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../lib-d3/lib-d3.html">
<link rel="import" href="../lib-d3-tip/lib-d3-tip.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<dom-module id="glyco-balls">

    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <div data-role="doughpie" data-width="450" data-height="450" id="graph"></div>


        <iron-ajax
                id="jsonLoad"
                url="../data/data.json"
                handle-as="json"
                on-response="loadVisualization"
                debounce-duration="300">
        </iron-ajax>

    </template>
    <script>

      /**
       * `glyco-balls`
       * Glycan balls to display concentration of glycans in glycoproteins.
       *
       * @customElement
       * @polymer
       * @demo demo/index.html
       */
      class GlycoBalls extends Polymer.Element {
        static get is() { return 'glyco-balls'; }
        static get properties() {
          return {
            selectedProtein: {
              type: String,
              referToAttribute: true,
              notify: true
            }
          };
        }

        connectedCallback() {
          super.connectedCallback();
          var ajaxCall = this.$.jsonLoad;
          ajaxCall.url = this.resolveUrl('data/data.json');
          ajaxCall.generateRequest();
        }

        loadVisualization(event){
          var data = event.detail.response;
          var graph = this.$.graph;
          var that = this;

          var width = 450,
              height = 450,
              radius = Math.min(width, height) / 2; //Radius of the whole circle


          var svg = d3.select(graph)
              .append("svg")
              .attr("width", width + 300)
              .attr("height", height + 150);

          var tooltip = d3.select("body")
              .append("div")
              .style("position", "absolute")
              .style("z-index", "10")
              .style("visibility", "hidden")
              .style("color", "white")
              .style("padding", "8px")
              .style("background-color", "rgba(0, 0, 0, 0.75)")
              .style("border-radius", "6px")
              .style("font", "12px sans-serif")
              .text("tooltip");

          //_create doughpie shell
          var doughpie = svg.append("g")
              .attr("class", "doughpie");

          doughpie.append("g")
              .attr("class", "slices");
          doughpie.append("g")
              .attr("class", "labels");
          doughpie.append("g")
              .attr("class", "lines");

          var pie = d3.layout.pie()
              .sort(null)
              .value(function (d) {
                return d.value;
              });

          var arc = d3.svg.arc()
              .outerRadius(radius * 0.90) //size of the radius of the outer circle
              .innerRadius(radius * 0.87);

          doughpie.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

          var key = function (d) {
            return d.data.label;
          };

          //this may be useful: http://bl.ocks.org/jfreyre/b1882159636cc9e1283a
          var color = d3.scale.ordinal()
              .range(["#d488c8", "#2cc15e", "#95A5A6", "#e14cc9", "#E57373", "#C5EFF7", "#2C3E50", "#4ff1e0", "#1E824C", "#D8D5DB", "#BA3B46", "#bde76c", "#96dbb1", "#EF8354", "#FFE8C2", "#0B1D51", "#A1869E", "#912F40", "#96C0B7", "#46a2de", "#7b3cce", "#de5942", "#31d99c", "#ffa618"]);


          //_create bubble
          var diameter = width / 2; //take half/width

          var bubs = svg.append("g")
              .attr("class", "bubs");

          bubs.attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

          var bubble = d3.layout.pack()
              .size([diameter, diameter])
              .value(function (d) {
                return d.size;
              })
              .padding(3);


          change(data);

          function change(data) {
              /* ------- ANIMATE PIE SLICES -------*/

              var slice = doughpie.select(".slices").selectAll("path.slice")
                .data(pie(data), key);


            slice.enter()
                .insert("path")
                .style("fill", function (d) {
                  return color(d.data.label); //colors
                })
                .attr("class", "slice");


            slice
                .transition().duration(1000)
                .attrTween("d", function (d) {
                  this._current = this._current || d;
                  var interpolate = d3.interpolate(this._current, d);
                  this._current = interpolate(0);
                  return function (t) {
                    return arc(interpolate(t));
                  };
                });

            slice.exit()
                .remove();
            /* ------- ANIMATE BUBBLES -------*/
            // generate data with calculated layout values

            var data = bubbledata(data);

            var nodes = bubble.nodes(data)
                .filter(function (d) {
                  return !d.children;
                }); // filter out the outer bubble


            var bubbles = bubs.selectAll('circle')
                .data(nodes);

            bubbles.enter()
                .insert("circle")
                .attr('transform', function (d) {
                  return 'translate(' + d.x + ',' + d.y + ')';
                })
                .attr('r', function (d) {
                  return d.r;
                })
                .style("fill", function (d) {
                  return color(d.group);
                })
                .on("mouseover", function (d) {
                  tooltip.text(d.group + ": " + d.value.toPrecision(2).toString() + " mg/ml");
                  tooltip.style("visibility", "visible");
                })
                .on("mousemove", function () {
                  return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px");
                })
                .on("click", function (d) {
                  that.selectedProtein = d.group.replace(/ /g,"_");
                })
                .on("mouseout", function () {
                  return tooltip.style("visibility", "hidden");
                });

            var legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", "translate(0,10)")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("g")
                .attr("transform", function (d, i) {
                  return "translate(" + d.depth * 500 + "," + i * 20 + ")";
                });
            // Draw rects, and color them by original_index
            legend.append("rect")
                .attr("width", 8)
                .attr("height", 8)
                .style("fill", function (d) {
                  return color(d.group)
                });

            legend.append("text")
                .attr("x", function (d, i) {
                  return d.depth * 10 + 10;
                })
                .attr("dy", "0.50em")
                .text(function (d) {
                  return d.group;
                });

            bubbles = bubbles.transition()
                .transition()
                .duration(400)
                .attr('transform', function (d) {
                  return 'translate(' + d.x + ',' + d.y + ')';
                })
                .attr('stroke-width', 0.5)
                .attr('r', function (d) {
                  return d.r;
                })
                .ease('sine');

            bubbles
                .transition().duration(1000)

          }

          function bubbledata(data) {
            //loop through data -- and MERGE children
            var childs = [];
            data.forEach( function(element){
              childs.push(element.children);
            });
            var merged = [].concat.apply([], childs); //flatterns multidimensional array
            var children = {
              "children": merged
            };

            return JSON.parse(JSON.stringify(children));// return deep clone

          }
        }
      }

      window.customElements.define(GlycoBalls.is, GlycoBalls);
    </script>
</dom-module>
